# 徹底レビュー実行プロンプト集

このドキュメントは、authsock-filterプロジェクトの包括的なコードレビューを
複数のサブエージェントで並列実行するためのプロンプト集です。

---

## 実行手順

### Phase 1: 並列レビュー実行

```
REVIEW_PROMPTS.md を読んで、以下の手順で徹底レビューを実施してください:

1. まずプロンプト1〜4（コアレビュー）を並列実行
2. 続いてプロンプト5〜6（オプションレビュー）を並列実行
3. 続いてプロンプト7〜11（UX・ドキュメント・テストレビュー）を並列実行
4. 最後にプロンプト12（総括レビュー）を実行

各レビュー結果を統合し、指摘事項を優先度順にリストアップしてください。
```

### Phase 2: 修正作業

```
レビュー結果に基づき、以下の手順で修正を進めてください:

1. 全指摘事項を優先度（Critical > High > Medium > Low）順にTodoリストに追加
2. サブエージェントを最大限活用して並列で修正可能な項目は並列実行
3. 各修正後にテスト（cargo test, cargo clippy）を実行
4. 修正完了後、関連するレビューを再実行して問題が解消されたか確認
5. 全ての指摘が解消されるまで「修正→テスト→再レビュー」を繰り返す
```

### 簡易実行コマンド

```
# コアレビューのみ（高速）
REVIEW_PROMPTS.md のプロンプト1〜4を並列実行

# フルレビュー（推奨）
REVIEW_PROMPTS.md のプロンプト1〜10を順次並列実行し、修正まで完了させる
```

---

## コアレビュー（必須）

### 1. セキュリティレビュー

```
authsock-filterプロジェクトのセキュリティレビューを実施してください。

レビュー観点:
1. **パース脆弱性**: SSH Agentプロトコルのパース処理（src/protocol/）でバッファオーバーフロー、整数オーバーフロー、不正なメッセージ処理はないか
2. **パス・環境変数展開**: shellexpand使用箇所でのインジェクション、パストラバーサル、シンボリックリンク攻撃
3. **Unixソケットパーミッション**: 作成するソケットファイルのパーミッション設定は適切か（他ユーザーからのアクセス防止）
4. **TOCTOUレース条件**: ファイル存在チェックとアクセスの間のレース条件
5. **デシリアライザー**: TOMLパース時の脆弱性（src/config/mod.rs）
6. **信頼境界**: 上流SSH Agentからのレスポンス検証

主要ファイル:
- src/protocol/mod.rs, message.rs, codec.rs
- src/config/mod.rs, file.rs
- src/utils/path.rs
- src/agent/server.rs, proxy.rs, upstream.rs
- src/cli/commands/run.rs

各問題について、ファイル:行番号、深刻度（Critical/High/Medium/Low）、推奨修正を報告してください。
```

---

### 2. アーキテクチャ・重複コードレビュー

```
authsock-filterプロジェクトのアーキテクチャと重複コードのレビューを実施してください。

レビュー観点:
1. **重複コード**: 同じ処理が複数箇所にないか、共通化すべきロジックはないか
2. **モジュール分割**: 責務が適切に分離されているか、循環依存はないか
3. **抽象化レベル**: 過度な抽象化や、逆に抽象化不足な箇所
4. **エラー型**: エラー型の設計は適切か、無駄な変換がないか
5. **非同期パターン**: tokioの使い方は適切か

主要ファイル:
- src/lib.rs（モジュール構成）
- src/error.rs
- src/agent/（プロキシ実装）
- src/filter/（フィルター評価）
- src/cli/（CLI処理）

具体的なコードを引用して、改善提案をファイル:行番号付きで報告してください。
```

---

### 3. CLI/Config整合性レビュー

```
authsock-filterプロジェクトのCLI引数とConfig相互変換の整合性レビューを実施してください。

レビュー観点:
1. **往復変換の整合性**: CLI → Config → CLI で情報が失われないか
2. **カスタムデシリアライザー**: serde のカスタム実装にバグはないか
3. **マージロジック**: 同一パスの --socket マージが正しく動作するか
4. **config command 出力**: 出力形式はシェルで正しく解釈されるか（エスケープ等）
5. **エッジケース**: 空のフィルター、特殊文字を含むパス等の処理

主要ファイル:
- src/cli/args.rs
- src/cli/commands/config.rs
- src/config/mod.rs
- src/config/file.rs

フィルター形式の仕様:
- Vec<Vec<String>> 形式（外側=OR、内側=AND）
- 同じ --socket PATH の複数指定 → filtersがORとしてマージ

具体的なコードを引用して問題点をファイル:行番号付きで報告してください。
```

---

### 4. エラーハンドリング・堅牢性レビュー

```
authsock-filterプロジェクトのエラーハンドリングと堅牢性のレビューを実施してください。

レビュー観点:
1. **unwrap/expect の使用**: パニックする可能性のある箇所はないか
2. **エラー伝播**: Result/Option の適切な処理
3. **リソースリーク**: ファイルハンドル、ソケット等の適切なクローズ
4. **タイムアウト**: 上流SSH Agentへの接続タイムアウト設定
5. **グレースフルシャットダウン**: シグナル処理、クリーンアップ
6. **inode監視ロジック**: src/cli/commands/run.rs での監視処理の堅牢性

主要ファイル:
- src/cli/commands/run.rs（inode監視）
- src/agent/server.rs, proxy.rs, upstream.rs
- src/protocol/codec.rs

unwrap/expect の使用箇所をリストアップし、各箇所が安全かどうか評価してください。ファイル:行番号付きで報告。
```

---

## オプションレビュー

### 5. ドキュメント・ユーザビリティレビュー

```
authsock-filterプロジェクトのドキュメントとユーザビリティレビューを実施してください。

レビュー観点:
1. **ドキュメントの正確性**: docs/*.md の内容が実装と一致しているか
2. **例の動作確認**: ドキュメント内のコード例が正しく動作するか
3. **シェルエスケープ**: コマンドライン例で特殊文字（*, $等）が適切にクオートされているか
4. **エラーメッセージ**: ユーザーフレンドリーなエラーメッセージか
5. **--help の内容**: ヘルプメッセージは十分か

主要ファイル:
- docs/ARCHITECTURE.md
- docs/CONFIGURATION.md
- docs/CLI.md
- docs/FILTERS.md
- src/cli/mod.rs（clap定義）

問題点と修正提案を報告してください。
```

---

### 6. パフォーマンス・並行性レビュー

```
authsock-filterプロジェクトのパフォーマンスと並行性レビューを実施してください。

レビュー観点:
1. **ロック競合**: RwLock/Mutex の使用箇所でデッドロックや競合はないか
2. **メモリ使用**: 不必要なクローン、大きなバッファの確保
3. **接続プーリング**: Upstream接続の効率性
4. **キャッシュ戦略**: GitHub APIキャッシュの適切性
5. **非同期タスク**: スポーン過多、タスクリーク

主要ファイル:
- src/agent/upstream.rs
- src/filter/github.rs
- src/filter/keyfile.rs
- src/cli/commands/run.rs

ボトルネックとなりうる箇所を特定し、改善案を提示してください。
```

---

## UX・ドキュメントセキュリティレビュー

### 7. ドキュメントセキュリティレビュー

```
authsock-filterプロジェクトのドキュメントセキュリティレビューを実施してください。

想定リスク: ユーザーがドキュメントの例をそのままコピペ実行した際のセキュリティ問題

レビュー観点:
1. **シェルGlob展開リスク**: `comment=*work*` のようなワイルドカードを含む例がクオートなしで記載されていないか
   - 危険: `--filter comment=*work*` → カレントディレクトリのファイル名に展開される
   - 安全: `--filter 'comment=*work*'` または `--filter "comment=*work*"`
2. **コマンドインジェクション**: ドキュメント内の例をコピペ実行した際に意図しないコマンドが実行される可能性
3. **環境変数展開**: `$HOME`, `${VAR}` などが意図せず展開される例がないか
4. **ファイル名・パスの特殊文字**: スペースや特殊文字を含むパス例での適切なクオート
5. **コピペ実行の安全性**: ユーザーがドキュメントの例を直接ターミナルにコピペして問題ないか

主要ファイル:
- README.md
- docs/FILTERS.md（フィルター構文の例）
- docs/CLI.md（コマンドライン例）
- docs/CONFIGURATION.md（設定例）
- docs/examples/（サンプル設定）

危険な例とその修正案を報告してください。
```

---

### 8. 初心者・一般ユーザーUXレビュー

```
authsock-filterプロジェクトを初心者・一般ユーザー視点でレビューしてください。

想定ユーザー: SSH Agentの仕組みをあまり理解していないが、SSHキーのセキュリティを向上させたい開発者

レビュー観点:
1. **初回セットアップ**: README/Quick Startを読んで実際に動かせるか
2. **概念の説明**: フィルターの「AND/OR」、「upstream」等の用語は理解しやすいか
3. **エラーメッセージ**: 何が問題で、どう修正すればいいか明確か
4. **デフォルト動作**: 設定なしで動かした場合の挙動は直感的か
5. **成功の確認方法**: 正しく動作しているか確認する方法が明示されているか
6. **よくある間違い**: FAQ/トラブルシューティングは十分か
7. **視覚的フィードバック**: プロキシ動作中のログ出力は理解しやすいか

主要ファイル:
- README.md
- docs/*.md
- src/cli/ のヘルプメッセージ

「これがわからなくて詰まりそう」というポイントを報告してください。
```

---

### 9. パワーユーザー・エキスパートUXレビュー

```
authsock-filterプロジェクトを高リテラシユーザー視点でレビューしてください。

想定ユーザー: シェルスクリプト、自動化、セキュリティに詳しいシステム管理者/DevOps

レビュー観点:
1. **シンプルさ**: 不要な機能や過度な抽象化がないか
2. **Unix哲学との親和性**: パイプ、スクリプト、他ツールとの連携のしやすさ
3. **冗長性**: 同じことを複数の方法で設定できる場合、混乱を招かないか
4. **デフォルトの妥当性**: sensible defaults になっているか
5. **自動化対応**: スクリプトからの利用、CI/CDでの利用は容易か
6. **終了コード**: エラー種別に応じた適切な終了コードを返すか
7. **ログレベル制御**: verbose/quiet の切り替えは十分か
8. **launchd/systemd統合**: サービス化の手順はスムーズか
9. **設定の移植性**: 設定を他マシンに持っていく際の問題

主要ファイル:
- docs/CLI.md
- src/cli/（終了コード、出力形式）
- docs/examples/

「もっとシンプルにできる」「この機能は不要」「この情報が足りない」を報告してください。
```

---

### 10. コード/ドキュメント同期レビュー（修正後チェック）

```
authsock-filterプロジェクトのコード修正とドキュメントの同期状態をレビューしてください。

想定: コード修正後にドキュメントの更新漏れがないかをチェックする専門家

レビュー観点:
1. **APIシグネチャ変更**:
   - CLIオプション追加・削除・変更 → docs/CLI.md、README.md更新要
   - 設定ファイル形式変更 → docs/CONFIGURATION.md、examples/更新要
   - フィルタ構文変更 → docs/FILTERS.md更新要

2. **動作仕様変更**:
   - デフォルト値変更 → 全ドキュメントの例を確認
   - エラーメッセージ変更 → トラブルシューティング更新要
   - 終了コード変更 → docs/CLI.md更新要

3. **アーキテクチャ変更**:
   - モジュール追加・削除 → docs/ARCHITECTURE.md更新要
   - 新しい依存関係 → Cargo.toml記載、README.mdに影響があれば更新要

4. **例とサンプルの整合性**:
   - docs/examples/*.toml は現在の設定形式に準拠しているか
   - README.mdのクイックスタート例は動作するか
   - --help出力とドキュメントの説明が一致しているか

5. **バージョン管理**:
   - CHANGELOG.mdに変更が記録されているか（存在する場合）
   - 破壊的変更がある場合、マイグレーションガイドがあるか

チェック方法:
1. git diff で変更されたコードファイルを特定
2. 変更内容がドキュメントに影響するか判定
3. 関連ドキュメントが更新されているか確認
4. 更新漏れを「ファイル:行番号」形式で報告

主要ファイル:
- 変更されたsrc/**/*.rs
- docs/*.md
- README.md
- docs/examples/*.toml

報告形式:
| コード変更 | 影響ドキュメント | 更新状態 | 必要なアクション |
|-----------|-----------------|---------|-----------------|
| src/cli/args.rs: 新オプション追加 | docs/CLI.md | ❌ 未更新 | オプション説明追加 |
```

---

### 11. テスト品質・カバレッジレビュー

```
authsock-filterプロジェクトのテスト品質とカバレッジをレビューしてください。

想定: テスト戦略の専門家として、考慮漏れ・エッジケース・特殊シナリオを徹底的に洗い出す

レビュー観点:
1. **境界値テスト**:
   - 空文字列、非常に長い文字列、Unicode文字、制御文字
   - 0バイト、最大サイズ、オーバーフロー境界
   - 空のフィルター、空のソケットリスト
2. **エッジケース**:
   - ソケットファイルが存在しない、権限がない、ディレクトリである
   - 上流Agentが応答しない、途中で切断、不正なレスポンス
   - 設定ファイルが空、不正なTOML、循環参照
3. **特殊シナリオ**:
   - 同時接続数が非常に多い場合
   - プロキシ起動中に上流ソケットが消える
   - シグナル受信タイミング（処理中にSIGINT）
   - ファイルシステムがfull、read-only
4. **セキュリティテスト**:
   - 悪意のあるSSH Agentメッセージ（不正な長さフィールド）
   - パストラバーサル攻撃を含むパス
   - シンボリックリンクを含むソケットパス
5. **回帰テスト**:
   - 過去のバグ修正に対するテストは存在するか
   - inode監視機能のテストは十分か
6. **テストの品質**:
   - テストが実際に意味のあるアサーションをしているか
   - モックが適切に使われているか
   - テストの独立性（順序依存していないか）

主要ファイル:
- tests/*.rs
- src/*/tests.rs（各モジュールのユニットテスト）
- src/protocol/codec.rs（プロトコルパース）
- src/filter/mod.rs（フィルター評価）

以下の形式で報告してください:
- **不足しているテストケース**: 具体的なテストシナリオと期待動作
- **既存テストの問題**: ファイル:行番号と問題点
- **優先度**: Critical（セキュリティ関連）> High（コア機能）> Medium > Low
```

---

## 総括レビュー

### 12. 総括・統合レビュー

```
authsock-filterプロジェクトの総括レビューを実施してください。
このレビューは他のレビュー結果を踏まえた最終チェックです。

レビュー観点:
1. **ドキュメントと実装の最終整合性**: 全ドキュメントが現在の実装を正確に反映しているか
2. **バージョン/リリース準備**: Cargo.toml、CHANGELOG、ライセンス表記
3. **依存関係の妥当性**: 使用クレートは最新・安全・必要最小限か
4. **テストカバレッジ**: 重要なパスがテストでカバーされているか
5. **セキュリティアドバイザリ**: 依存クレートに既知の脆弱性がないか（cargo audit相当）
6. **READMEの第一印象**: プロジェクトの目的・価値が30秒で伝わるか
7. **クロスリファレンス**: ドキュメント間のリンク切れ、用語の不一致

主要ファイル:
- Cargo.toml, Cargo.lock
- README.md
- docs/*.md（全ファイル）
- tests/

公開前に修正すべき項目を優先度付きでリストアップしてください。
```

---

## レビュー結果の統合テンプレート

各レビュー完了後、以下の形式で統合します:

```markdown
# レビュー結果サマリー

## Critical（即座に修正必須）
- [ ] 項目1 (レビュー#X より)
- [ ] 項目2 (レビュー#X より)

## High（リリース前に修正）
- [ ] 項目1 (レビュー#X より)
- [ ] 項目2 (レビュー#X より)

## Medium（改善推奨）
- [ ] 項目1 (レビュー#X より)
- [ ] 項目2 (レビュー#X より)

## Low（時間があれば対応）
- [ ] 項目1 (レビュー#X より)
- [ ] 項目2 (レビュー#X より)
```

---

## コンテキスト管理と引き継ぎ

**重要**: メインコンテキストが70%を超えたら、以下を実施してください：

1. **進捗の保存**: 現在の作業状態を `SESSION_HANDOFF.md` に記録
2. **未完了タスクの明確化**: 残りの作業をTodoリストまたはドキュメントに記録
3. **次セッションへの引き継ぎ**: `/handoff` スキルを使用して引き継ぎ資料を作成

### 引き継ぎドキュメントに含めるべき情報
- 完了したレビュー/修正の一覧
- 未完了のタスクと優先度
- 発見した問題で未修正のもの
- 次のセッションで最初にすべきこと

---

## 重要: サブエージェント活用の原則

**メインコンテキストを節約するため、可能な限りサブエージェントで作業すること。**

- コード修正、テスト追加、ドキュメント更新など、独立したタスクはサブエージェントに委譲
- メインには結果のみ返却されるため、詳細な作業ログでコンテキストを消費しない
- 複数タスクは並列実行で高速化（**並列度は3〜5程度まで**、10並列など過剰な並列は不安定になる）
- **確認不要**: 続けるか、進める順番などの確認は不要。やるべきことは確認なしで進める

---

## 修正ワークフロー

```
修正作業は以下のサイクルで実施:

1. **計画**: 指摘事項をTodoリストに優先度順で追加
2. **並列修正**: 独立した修正はサブエージェントで並列実行
   - コード修正エージェント
   - ドキュメント修正エージェント
   - テスト追加エージェント
3. **検証**:
   - cargo fmt --check
   - cargo clippy -- -D warnings
   - cargo test
4. **再レビュー**: 修正箇所に関連するレビューを再実行
5. **繰り返し**: 全ての指摘が解消されるまで2-4を繰り返す
```
