# authsock-filter 徹底レビュー結果

実施日: 2026-01-06
レビュー数: 12（コア4 + オプション2 + UX/テスト5 + 総括1）

---

## Critical（即座に修正必須）

### C-1. README.mdのフィルタ構文が実装と不一致
- **ファイル**: `README.md:122-133`
- **レビュー**: #3 CLI/Config整合性, #10 コード/ドキュメント同期, #12 総括
- **問題**: 設定ファイル例が `type:value` 形式だが、実装は `type=value` 形式
- **修正**: 全例を `type=value` 形式に統一、否定は `not-type=dsa` に

### C-2. README.mdのシェルGlob展開リスク
- **ファイル**: `README.md:31,80,86,87,148,149,171`
- **レビュー**: #7 ドキュメントセキュリティ
- **問題**: `comment=*@work*` がクオートなしで記載、コピペ実行でGlob展開
- **修正**: 全例をシングルクォートで保護 `'comment=*@work*'`

### C-3. README.mdのコマンド構成が実装と不一致
- **ファイル**: `README.md:39-59`
- **レビュー**: #5 ドキュメント, #10 コード/ドキュメント同期
- **問題**: `start`, `stop`, `status`, `upgrade`, `register`, `unregister` は存在しない
- **修正**: `service` サブコマンド構成に更新

### C-4. RwLock poisoning によるパニック
- **ファイル**: `src/filter/github.rs:81,85,91`
- **レビュー**: #1 セキュリティ, #4 エラーハンドリング
- **問題**: `matchers.write().unwrap()` でロック毒化時にパニック
- **修正**: `map_err()` で poison エラーをハンドリング、または `parking_lot::RwLock` を使用

---

## High（リリース前に修正）

### H-1. Unixソケットのパーミッション設定が明示的でない
- **ファイル**: `src/agent/server.rs:69`, `src/cli/commands/run.rs:126`
- **レビュー**: #1 セキュリティ
- **問題**: UnixListenerのbind時にパーミッションを明示的に設定していない
- **修正**: ソケット作成後に `chmod 0600` を設定

### H-2. TOCTOU レース条件（シンボリックリンク攻撃）
- **ファイル**: `src/agent/server.rs:44-53`, `src/cli/commands/run.rs:109-115`
- **レビュー**: #1 セキュリティ
- **問題**: `exists()` チェック後に `remove_file()` 前にシンボリックリンク置換可能
- **修正**: `lstat()` でシンボリックリンク確認

### H-3. ソケット操作の重複コード
- **ファイル**: `src/agent/server.rs`, `src/cli/commands/run.rs`
- **レビュー**: #2 アーキテクチャ
- **問題**: ソケット削除・ディレクトリ作成・権限設定が重複
- **修正**: `src/utils/socket.rs` にユーティリティ関数化

### H-4. service.rs の expect() によるパニック
- **ファイル**: `src/cli/commands/service.rs:273,320`
- **レビュー**: #4 エラーハンドリング
- **問題**: `dirs::home_dir().expect()` でホームディレクトリ取得失敗時にパニック
- **修正**: `Result` を返してエラーハンドリング

### H-5. 上流SSH Agentへの接続タイムアウト未設定
- **ファイル**: `src/agent/upstream.rs:54`
- **レビュー**: #4 エラーハンドリング
- **問題**: 上流Agentへの接続にタイムアウトがない
- **修正**: `tokio::time::timeout` でラップ

### H-6. 終了コードが未定義
- **ファイル**: `src/main.rs`
- **レビュー**: #9 パワーユーザーUX
- **問題**: 常にexit(0)または1、スクリプト統合困難
- **修正**: `ExitCode` enumを定義しドキュメント化

### H-7. GitHubキャッシュのサンダリングハード問題
- **ファイル**: `src/filter/github.rs:117-123`
- **レビュー**: #6 パフォーマンス
- **問題**: キャッシュ失効時に複数スレッドが同時にGitHub APIへリクエスト
- **修正**: フェッチ中フラグ（`AtomicBool`）を導入

### H-8. 同期RwLockの非同期コンテキストでの使用
- **ファイル**: `src/filter/github.rs`, `src/filter/keyfile.rs`
- **レビュー**: #6 パフォーマンス
- **問題**: `std::sync::RwLock` がTokioランタイムをブロック
- **修正**: `tokio::sync::RwLock` に置き換え

### H-9. CHANGELOG ファイルが存在しない
- **レビュー**: #12 総括
- **問題**: 変更履歴を追跡できない
- **修正**: `CHANGELOG.md` を作成

### H-10. docs/cli-design.md の記載が古い
- **ファイル**: `docs/cli-design.md`
- **レビュー**: #10 コード/ドキュメント同期, #12 総括
- **問題**: 複数upstreamは実装済みだが「Future Design」として記載
- **修正**: ドキュメントを現状に合わせて更新

---

## Medium（改善推奨）

### M-1. SSH Agentプロトコルの境界値テスト不足
- **ファイル**: `src/protocol/codec.rs`, `tests/`
- **レビュー**: #11 テスト品質
- **問題**: MAX_MESSAGE_SIZE、不正長さ、0バイトメッセージのテストなし
- **修正**: 境界値テスト追加

### M-2. inode監視機能のテスト不足
- **ファイル**: `src/cli/commands/run.rs`, `tests/`
- **レビュー**: #11 テスト品質
- **問題**: Commit 81f7b2d の機能に対するテストがない
- **修正**: integration テスト追加

### M-3. 上流Agent接続エラー処理のテスト不足
- **ファイル**: `src/agent/upstream.rs`, `tests/`
- **レビュー**: #11 テスト品質
- **問題**: 接続拒否、タイムアウト、途中切断のテストなし
- **修正**: エラーシナリオテスト追加

### M-4. Serialize/Deserialize の非対称性
- **ファイル**: `src/config/mod.rs:48-107`
- **レビュー**: #3 CLI/Config整合性
- **問題**: カスタム`deserialize_with`があるが対応する`serialize_with`がない
- **修正**: 往復変換で形式が変わらないよう修正

### M-5. 整数変換時の潜在的オーバーフロー
- **ファイル**: `src/protocol/message.rs:185,223`
- **レビュー**: #1 セキュリティ
- **問題**: `count as usize` でオーバーフローの可能性
- **修正**: `try_from()` で安全な変換

### M-6. メモリ割り当ての制御
- **ファイル**: `src/protocol/message.rs:185`
- **レビュー**: #1 セキュリティ
- **問題**: 悪意のある `count` 値で大量メモリ割り当て可能
- **修正**: `MAX_IDENTITIES` 定数で上限を設定

### M-7. HTTPクライアントの毎回作成
- **ファイル**: `src/filter/github.rs:58-60`
- **レビュー**: #6 パフォーマンス
- **問題**: `reqwest::Client` を毎回再構築
- **修正**: `OnceCell` でクライアントを共有

### M-8. Upstream接続の非効率性
- **ファイル**: `src/agent/proxy.rs`, `src/agent/upstream.rs`
- **レビュー**: #6 パフォーマンス
- **問題**: リクエストごとに新規接続を作成
- **修正**: クライアント接続ごとにUpstream接続を保持

### M-9. SSH Agentの基本概念説明不足
- **ファイル**: `README.md`
- **レビュー**: #8 初心者UX
- **問題**: 「なぜSSH Agentにフィルターが必要か」の説明がない
- **修正**: モチベーションセクション追加

### M-10. 動作確認方法がない
- **ファイル**: `README.md`
- **レビュー**: #8 初心者UX
- **問題**: フィルターが正しく機能しているか確認する方法がない
- **修正**: 検証手順を追加

---

## Low（時間があれば対応）

### L-1. 不必要なクローンとメモリアロケーション
- **ファイル**: `src/agent/proxy.rs`
- **レビュー**: #6 パフォーマンス
- **問題**: `key_blob.to_vec()` で Bytes → Vec<u8> コピー
- **修正**: `HashSet<Bytes>` を使用

### L-2. AtomicU64 の Ordering
- **ファイル**: `src/agent/proxy.rs:26`
- **レビュー**: #6 パフォーマンス
- **問題**: `Ordering::SeqCst` は過剰
- **修正**: `Ordering::Relaxed` に変更

### L-3. shutdown_txの未使用変数
- **ファイル**: `src/cli/commands/run.rs`
- **レビュー**: #6 パフォーマンス
- **問題**: `_shutdown_rx` が即座にドロップ
- **修正**: 使用するか削除

### L-4. スペースを含むパスのクオート統一
- **ファイル**: `README.md:88`
- **レビュー**: #7 ドキュメントセキュリティ
- **問題**: バックスラッシュエスケープよりダブルクオートが読みやすい
- **修正**: ダブルクオートに統一

### L-5. SIGHUPによるリロードが未実装
- **ファイル**: `src/cli/commands/run.rs`
- **レビュー**: #9 パワーユーザーUX
- **問題**: README記載があるが未実装
- **修正**: 実装するかREADMEから削除

### L-6. `--log`オプションが存在しない
- **ファイル**: `README.md`
- **レビュー**: #5 ドキュメント, #9 パワーユーザーUX
- **問題**: ドキュメントに記載があるが未実装
- **修正**: 実装するかREADMEから削除

### L-7. version サブコマンドと --version の重複
- **レビュー**: #9 パワーユーザーUX
- **問題**: 両方存在し同じ情報を出力
- **修正**: 必要性を検討

### L-8. GitHub APIステータスコード未確認
- **ファイル**: `src/filter/github.rs:62-63`
- **レビュー**: #1 セキュリティ
- **問題**: HTTPステータスコードを検証していない
- **修正**: `response.status().is_success()` をチェック

### L-9. パストラバーサル攻撃のテスト不足
- **ファイル**: `src/utils/path.rs`, `tests/`
- **レビュー**: #11 テスト品質
- **問題**: `../../../etc/passwd` などのテストがない
- **修正**: セキュリティテスト追加

### L-10. 日本語コメントの混在
- **ファイル**: `src/cli/mod.rs:89-90,93`
- **レビュー**: #5 ドキュメント
- **問題**: 英語のヘルプメッセージ中に日本語コメント混在
- **修正**: 一貫性のある言語に統一

---

## 統計

| 優先度 | 件数 |
|--------|------|
| Critical | 4 |
| High | 10 |
| Medium | 10 |
| Low | 10 |
| **合計** | **34** |

---

## 修正作業の推奨順序

### Phase 1: ドキュメント修正（並列実行可能）
- [ ] C-1: README.md フィルタ構文修正 (`type:` → `type=`)
- [ ] C-2: README.md シェルクオート修正
- [ ] C-3: README.md コマンド構成修正
- [ ] H-9: CHANGELOG.md 作成
- [ ] H-10: docs/cli-design.md 更新
- [ ] M-9, M-10: README.md に概念説明・検証方法追加

### Phase 2: セキュリティ修正（優先）
- [ ] C-4: RwLock poisoning 対策
- [ ] H-1: ソケットパーミッション設定
- [ ] H-2: TOCTOU レース条件対策
- [ ] H-4: service.rs expect() 対策
- [ ] M-5, M-6: 整数オーバーフロー・メモリ制限

### Phase 3: コード品質改善
- [ ] H-3: ソケット操作のユーティリティ化
- [ ] H-5: 上流接続タイムアウト追加
- [ ] H-7, H-8: GitHub キャッシュ・RwLock 改善
- [ ] M-7, M-8: HTTPクライアント共有・接続再利用

### Phase 4: テスト追加
- [ ] M-1: プロトコル境界値テスト
- [ ] M-2: inode監視テスト
- [ ] M-3: 上流接続エラーテスト

### Phase 5: UX改善
- [ ] H-6: 終了コード定義
- [ ] L-5, L-6: 未実装機能の対応決定
